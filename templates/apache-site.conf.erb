# This file is managed by Puppet.
# Any local changes will be overwritten.

# Koha instance <%= @site_name %> Apache config.

<% if @ssl_only != true -%>
# OPAC
<VirtualHost *:<%= @opac_port %>>
   Include /etc/koha/apache-shared.conf
#  Include /etc/koha/apache-shared-disable.conf
   Include /etc/koha/apache-shared-opac.conf

   ServerName <%= @_opac_server_name %>
   SetEnv KOHA_CONF "<%= @koha_site_dir %>/<%= @site_name %>/koha-conf.xml"
   SetEnv MEMCACHED_SERVERS "<%= @_memcached_servers %>"
   SetEnv MEMCACHED_NAMESPACE "<%= @memcached_namespace %>"
   AssignUserID <%= @_koha_user %> <%= @_koha_user %>

<% if @_opac_error_log -%>
   ErrorLog    <%= @_opac_error_log %>
<%- end -%>
<%- if @_opac_access_log -%>
   TransferLog <%= @_opac_access_log %>
<%- end -%>
<% if @_use_rewrite_log == true and @_opac_rewrite_log -%>
   RewriteLog  <%= @_opac_rewrite_log %>
<%- end -%>
</VirtualHost>

<%- end -%>
<% if @_opac_ssl == true and @opac_ssl_port -%>
# OPAC (SSL)
<VirtualHost *:<%= @opac_ssl_port %>>
   Include /etc/koha/apache-shared.conf
#  Include /etc/koha/apache-shared-disable.conf
   Include /etc/koha/apache-shared-opac.conf

   ServerName <%= @_opac_server_name %>
   SetEnv KOHA_CONF "<%= @koha_site_dir %>/<%= @site_name %>/koha-conf.xml"
   SetEnv MEMCACHED_SERVERS "<%= @_memcached_servers %>"
   SetEnv MEMCACHED_NAMESPACE "<%= @_memcached_namespace %>"
   AssignUserID <%= @_koha_user %> <%= @_koha_user %>

<% if @_opac_error_ssl_log -%>
   ErrorLog    <%= @_opac_error_ssl_log %>
<%- end -%>
<%- if @_opac_access_ssl_log -%>
   TransferLog <%= @_opac_access_ssl_log %>
<%- end -%>
<% if @_use_rewrite_log == true and @_opac_rewrite_ssl_log -%>
   RewriteLog  <%= @_opac_rewrite_ssl_log %>
<%- end -%>

   SSLEngine on
   SSLCertificateFile      "<%= @opac_ssl_certificate_file %>"
   SSLCertificateKeyFile   "<%= @opac_ssl_certificate_key_file %>"
   SSLCACertificatePath    "<%= @opac_ssl_ca_certificate_path %>"
</VirtualHost>

<%- end -%>
<% if @ssl_only != true -%>
# Intranet
<VirtualHost *:<%= @intra_port %>>
   Include /etc/koha/apache-shared.conf
#  Include /etc/koha/apache-shared-disable.conf
   Include /etc/koha/apache-shared-intranet.conf
   
   ServerName <%= @_intra_server_name %>
   SetEnv KOHA_CONF "<%= @koha_site_dir %>/<%= @site_name %>/koha-conf.xml"
   SetEnv MEMCACHED_SERVERS "<%= @_memcached_servers %>"
   SetEnv MEMCACHED_NAMESPACE "<%= @_memcached_namespace %>"
   AssignUserID <%= @_koha_user %> <%= @_koha_user %>

<% if @_intranet_error_log -%>
   ErrorLog    <%= @_intranet_error_log %>
<%- end -%>
<%- if @_intranet_access_log -%>
   TransferLog <%= @_intranet_access_log %>
<%- end -%>
<%- if @_use_rewrite_log == true and @_intranet_rewrite_log -%>
   RewriteLog  <%= @_intranet_rewrite_log %>
<%- end -%>
</VirtualHost>

<%- end -%>
<% if @_intra_ssl == true and @intra_ssl_port -%>
# Intranet (SSL)
<VirtualHost *:<%= @intra_ssl_port %>>
   Include /etc/koha/apache-shared.conf
#  Include /etc/koha/apache-shared-disable.conf
   Include /etc/koha/apache-shared-intranet.conf
   
   ServerName <%= @_intra_server_name %>
   SetEnv KOHA_CONF "<%= @koha_site_dir %>/<%= @site_name %>/koha-conf.xml"
   SetEnv MEMCACHED_SERVERS "<%= @_memcached_servers %>"
   SetEnv MEMCACHED_NAMESPACE "<%= @_memcached_namespace %>"
   AssignUserID <%= @_koha_user %> <%= @_koha_user %>

<% if @_intranet_error_ssl_log -%>
   ErrorLog    <%= @_intranet_error_ssl_log %>
<%- end -%>
<%- if @_intranet_access_ssl_log -%>
   TransferLog <%= @_intranet_access_ssl_log %>
<%- end -%>
<%- if @_use_rewrite_ssl_log == true and @_intranet_rewrite_ssl_log -%>
   RewriteLog  <%= @_intranet_rewrite_ssl_log %>
<%- end -%>

   SSLEngine on
   SSLCertificateFile      "<%= @intra_ssl_certificate_file %>"
   SSLCertificateKeyFile   "<%= @intra_ssl_certificate_key_file %>"
   SSLCACertificatePath    "<%= @intra_ssl_ca_certificate_path %>"
</VirtualHost>
<%- end -%>
